/*! 
 * piewpiew - v0.0.2 - 2012-06-20
 * http://github.com/bernos/piewpiew-js
 * Copyright (c) 2012 Brendan McMahon;
 */
(function(a){var b={};b.DEVELOPMENT="development",b.TESTING="testing",b.PRODUCTION="production";var c={underscore:a._,backbone:a.Backbone,jquery:a.jQuery};b.extend=function(a){for(var b=0,c=arguments.length;b<c;b++){var d=arguments[b];for(var e in d)a[e]=d[e]}return a},b.printf=function(a,b){for(var c in b){var d=new RegExp("\\$\\{"+c+"\\}","g");a=a.replace(d,b[c])}return a},b.configValue=function(a){return typeof a=="function"?a():a};var d=!1;b.Class=function(){var a=null,c=null,e=function(){d||this.initialize.apply(this,arguments)};return typeof arguments[0]=="function"?(c=arguments[0],a=arguments[1]):a=arguments[0],c&&(d=!0,e.prototype=new c,d=!1),b.extend(e.prototype,a),e.prototype.constructor=e,e.prototype.initialize||(e.prototype.initialize=function(){}),e.extend=function(a){return b.Class(this,a)},e},b.define=function(a,b,d){if(typeof define=="function"&&define.amd)define(a,b,d);else{if(b&&b.length)for(var e=0;e<b.length;e++)b[e]=c[b[e]];c[a]=d.apply(this,b||[])}},a.piewpiew=b,typeof exports!="undefined"&&(exports.piewpiew=b),typeof define=="undefined"&&(a.define=b.define),b.define("piewpiew.core",[],function(){return b})})(typeof window=="undefined"?this:window),define("piewpiew.views.Helpers",["underscore"],function(a){return{renderTemplate:function(b,c){return a.template(b,this.templateContext(c))},templateContext:function(b){return a.extend(b,this)},Html:{attributeString:function(b){var c=[];return a.each(b,function(a,b){b=="classes"&&(b="class",typeof a.join=="function"&&(a=a.join(" "))),c.push(piewpiew.printf('${key}="${value}"',{key:b,value:a}))}),c.join(" ")},editorForModel:function(a){return Template.renderTemplate(a.editorTemplate(),a.editorTemplateContext())},formField:function(a,b,c){return c||(c={}),c.classes||(c.classes=[]),c.classes.push("control"),c.classes.push("control-for-"+b.name),b.render(a.get(b.name),c)},hidden:function(a,b){return piewpiew.printf('<hidden name="${name}" value="${value}"/>',{name:a,value:b})},label:function(a,b,c){return piewpiew.printf('<label for="${name}" ${attributes}>${value}</label>',{name:a,value:b,attributes:this.attributeString(c)})},textfield:function(a,b,c){return piewpiew.printf('<input name="${name}" type="text" value="${value}" ${attributes}/>',{name:a,value:b!=null?b:"",attributes:this.attributeString(c)})}}}}),define("piewpiew.views.Region",["piewpiew.core"],function(a){return a.Class({initialize:function(a){if(!a.selector)throw"Cannot initialize a Region without a selector.";return this.views=[],this.selector=a.selector,this},addView:function(a){return this.views.push(a),a},removeView:function(a){for(var b=0,c=this.views.length;b<c;b++)if(this.views[b]==a)return this.views.splice(b,1),a;return a},render:function(a){for(var b in this.views)a.$(this.selector).append(this.views[b].render().el)}})}),define("piewpiew.views.View",["backbone","piewpiew.views.Helpers"],function(a,b){return a.View.extend({template:"No template specified for view",templateFunction:function(a,c){return b.renderTemplate(a,c)},templateContext:function(){return this.model?typeof this.model.toJSON=="function"?this.model.toJSON():this.model:{}},render:function(){var a=null;return typeof this.template=="function"?a=this.template():a=this.template,$(this.el).html(this.templateFunction(a,this.templateContext())),this}})}),define("piewpiew.views.CollectionView",["piewpiew.views.View"],function(a){return a.extend({template:"",view:a,initialize:function(a){var b;a||(a={});if(b=this.defaults)typeof b=="function"&&(b=b.call(this)),a=_.extend({},b,a);a.view&&(this.view=a.view),this.views=[],this.collection&&(this.collection.bind("reset",this.onCollectionReset,this),this.collection.bind("add",this.onCollectionItemAdded,this),this.collection.bind("remove",this.onCollectionItemRemoved,this))},getListEl:function(){return this.$el},onCollectionReset:function(){this.render()},onCollectionItemAdded:function(a,b,c){this.addItem(a)},onCollectionItemRemoved:function(a,b,c){this.removeItem(a)},addItem:function(a){var b=new this.view({model:a});return b.bind("all",this.proxyEvent,this),this.$el.append(b.render().el),this.views.push(b),this},removeItem:function(a){for(var b=null,c=0,d=this.views.length;c<d;c++){b=this.views[c];if(b.model==a){this.views.splice(c,1),b.unbind("all",this.proxyEvent,this),b.remove();break}}return this},clear:function(){for(var a=null,b=0,c=this.views.length;b<c;b++)a=this.views[b],a.remove();this.views=[]},render:function(){this.clear(),a.prototype.render.apply(this);if(this.collection){var b=this;_.each(this.collection.models,function(a){b.addItem(a)},this)}return this},proxyEvent:function(){this.trigger.apply(this,arguments)}})}),define("piewpiew.views.FormView",["jquery","piewpiew.views.View"],function(a,b){return a.fn.serializeObject=function(){var b={},c=this.serializeArray();return a.each(c,function(){b[this.name]!==undefined?(b[this.name].push||(b[this.name]=[b[this.name]]),b[this.name].push(this.value||"")):b[this.name]=this.value||""}),b},b.extend({initialize:function(a){this.model&&this.model.bind("error",this.handleError,this)},template:function(){return['<form class="form-horizontal">',"  <% if (null != model.id) { %>",'    <%= Html.hidden("id", model.id) %>',"  <% } %>",'  <%= Html.hidden("cid", model.cid) %>',"  <% _.each(model.fields, function(field, name) { %>","    <div>",'      <div class="control-group control-group-for-<%= name %>">','        <label class="control-label"><%= field.label %></label>','        <div class="controls"><%= Html.formField(model, field) %></div>',"      </div>","    </div>","  <% }) %>",'  <input type="submit" value="save"/>',"</form>"].join("\n")},templateContext:function(){return{model:this.model}},events:{"submit form":"handleSubmit","blur input":"handleBlur","focus input":"handleFocus"},handleSubmit:function(a){var b=this.$("form").serializeObject();this.clearErrors(),null!=this.model&&this.model.set(b)&&this.trigger("submit",this),a.preventDefault()},handleFocus:function(a){},handleBlur:function(b){var c=a(b.target);this.clearErrorFor(c.attr("name")),this.model.set(c.attr("name"),c.val())},handleError:function(a,b){var c=this;_.each(b,function(a,b){var d=c.formatErrorMessagesFor(b,a),e=c.formatErrorElementFor(b,d);c.clearErrorFor(b),c.attachErrorElementFor(b,e)})},clearErrors:function(){this.$(".control-group.error .help-inline").remove(),this.$(".control-group.error").removeClass("error")},clearErrorFor:function(a){this.$(".control-group-for-"+a+".error .help-inline").remove(),this.$(".control-group-for-"+a+".error").removeClass("error")},formatErrorMessagesFor:function(a,b){return b.join(" ")},formatErrorElementFor:function(a,b){return'<span class="help-inline generated">'+b+"</span>"},attachErrorElementFor:function(a,b){var c=this.$("*[name="+a+"]");c.parent().append(b),c.closest(".control-group").addClass("error")}})}),define("piewpiew.views.Layout",["piewpiew.views.View","piewpiew.views.Region"],function(a,b){return a.extend({addRegion:function(a){var c=new b(a);return null==this.regions&&(this.regions=[]),this.regions.push(c),c},render:function(){a.prototype.render.apply(this);if(null!=this.regions)for(var b in this.regions)this.regions[b].render(this);return this}})}),define("piewpiew.views",["piewpiew.core","piewpiew.views.Helpers","piewpiew.views.Region","piewpiew.views.View","piewpiew.views.CollectionView","piewpiew.views.FormView","piewpiew.views.Layout"],function(a,b,c,d,e,f,g){return a.views={View:d,CollectionView:e,FormView:f,Region:c,Layout:g,Helpers:b},a.views}),define("piewpiew.forms",["underscore","backbone","piewpiew.core"],function(a,b,c){var d={};return d.Form=b.Model.extend({initialize:function(b,c){this.fields||(this.fields={}),a.each(this.fields,function(a,b){a.name=b,a.label||(a.label=b)})},validate:function(b){console.log("validate",b);var c={},d=!0,e=this;a.each(b,function(a,b){if(e.fields[b]){var f=e.fields[b].validate(a);f&&(d=!1,c[b]=f)}});if(!d)return c},submit:function(a){}}),d.ModelForm=d.Form.extend({initialize:function(b,c){this.fields||(this.fields={});if(this.model){var e=this;a.each(this.model.prototype.fields,function(a,b){e.fields[b]==null&&(e.fields[b]=e.getFormFieldForModelField(a))})}d.Form.prototype.initialize.apply(this,arguments)},getFormFieldForModelField:function(a){return"TBA"},save:function(){this.validate}}),c.forms=d,d}),define("piewpiew.forms.fields",["piewpiew.core","piewpiew.forms","piewpiew.validators","piewpiew.views.Helpers"],function(a,b,c,d){var e={};return e.Field=a.Class({required:!1,requiredMessage:"${label} is a required field",invalidTypeMessage:"The value of ${label} is invalid",initialize:function(b){b||(b={}),a.extend(this,b),this.validators=this.defaultValidators(),a.extend(this.validators,b.validators)},defaultValidators:function(){return{}},render:function(a,b){return""},validate:function(b){var c=[];return this.validateType(b)||c.push(a.printf(this.invalidTypeMessage,this)),this.required&&!this.validateRequired(b)&&c.push(a.printf(this.requiredMessage,this)),_.each(this.validators,function(a,d){var e=a.validate(b);null!=e&&(c=c.concat(e))}),c.length>0?c:!1},validateType:function(a){return!0},validateRequired:function(a){return null==a?!1:typeof a=="string"&&a==""?!1:!0}}),e.TextField=e.Field.extend({minLength:-1,maxLength:-1,regex:/./,defaultValidators:function(){return{length:new c.StringValidator({minLength:this.minLength,maxLength:this.maxLength}),regex:new c.RegexValidator({pattern:this.regex})}},render:function(a,b){return d.Html.textfield(this.name,a,b)}}),b.fields=e,b.fields}),define("piewpiew.models",["underscore","backbone","piewpiew.core"],function(a,b,c){var d={};d.Config={messages:{},templates:{modelEditor:function(){var a=[];return a.push("<% _.each(model.fields, function(field, name) { %>"),a.push("<div>"),a.push("<%= Html.editorForField(model, field) %>"),a.push("</div>"),a.push("<% }); %>"),a.join("\n")}}};var e=c.configValue,f=d.Config,g=d.Config.messages,h=d.Config.templates;return d.Model=b.Model.extend({toJSON:function(){return a.extend(b.Model.prototype.toJSON.apply(this),{id:this.id,cid:this.cid})},editorTemplate:function(){return e(h.modelEditor)},editorTemplateContext:function(){return{model:this}},initialize:function(b,c){this.fields||(this.fields={}),a.each(this.fields,function(a,b){a.name=b})},validate:function(b){var c={},d=!0,e=this;a.each(b,function(a,b){if(e.fields[b]){var f=e.fields[b].validate(a);f&&(d=!1,c[b]=f)}});if(!d)return c}}),c.models=d,d}),define("piewpiew.validators",["piewpiew.core"],function(a){var b={};return b.Validator=a.Class({initialize:function(b){b||(b={}),b.messages||(b.messages={}),a.extend(this,b),this.messages=this.defaultMessages(),a.extend(this.messages,b.messages)},defaultMessages:function(){return{}},validate:function(a){return[]}}),b.StringValidator=b.Validator.extend({minLength:-1,maxLength:-1,defaultMessages:function(){return{tooLongNoMinLength:b.StringValidator.messages.tooLongNoMinLength,tooShortNoMaxLength:b.StringValidator.messages.tooShortNoMaxLength,outOfRange:b.StringValidator.messages.outOfRange}},validate:function(b){var c=[];return this.maxLength>-1&&b.length>this.maxLength&&c.push(this.minLength>-1?a.printf(this.messages.outOfRange,this):a.printf(this.messages.tooLongNoMinLength,this)),this.minLength>-1&&b.length<this.minLength&&c.push(this.maxLength>-1?a.printf(this.messages.outOfRange,this):a.printf(this.messages.tooShortNoMaxLength,this)),c}}),b.StringValidator.messages={tooLongNoMinLength:"String must have no more than ${maxLength} characters",tooShortNoMaxLength:"String must have at least ${minLength} characters",outOfRange:"String must have between ${minLength} and ${maxLength} characters"},b.RangeValidator=b.Validator.extend({min:0,max:-1,defaultMessages:function(){return{outOfRange:b.RangeValidator.messages.outOfRange}},validate:function(b){var c=[];return this.max<this.min?c:((b<this.min||b>this.max)&&c.push(a.printf(this.messages.outOfRange,this)),c)}}),b.RangeValidator.messages={outOfRange:"A value between ${min} and ${max} is required."},b.RegexValidator=b.Validator.extend({regex:/./,defaultMessages:function(){return{invalid:b.RegexValidator.messages.invalid}},validate:function(b){var c=[];return this.regex.test(b)||c.push(a.printf(this.messages.invalid,{value:b})),c}}),b.RegexValidator.messages={invalid:"The supplied string does not match the regular expression."},b.EmailValidator=b.RegexValidator.extend({regex:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,defaultMessages:function(){return{invalid:b.EmailValidator.messages.invalid}}}),b.EmailValidator.messages={invalid:"${value} is not a valid email address."},b}),define("piewpiew.models.fields",["underscore","backbone","piewpiew.core","piewpiew.models","piewpiew.validators"],function(a,b,c,d,e){var f={};f.Config={messages:{required:"${label} is a required field",invalidType:"The value of ${label} is invalid",stringFieldInvalidType:"${label} must be a string",stringFieldTooLongNoMinLength:"${label} must have no more than ${maxLength} characters",stringFieldTooShortNoMaxLength:"${label} must have at least ${minLength} characters",stringFieldOutOfRange:"${label} must have between ${minLength} and ${maxLength} characters",emailFieldInvalidEmailMessage:"${value} is not a valid email address."},templates:{fieldLabel:"<%= Html.label(name, value, attributes) %>",fieldEditor:'<div <%= Html.attributeString(attributes) %>><%= Html.labelForField(model, field) %><div class="controls"><%= Html.formControlForField(model, field) %></div></div>',stringFieldFormControl:"<%= Html.textfield(name, value, attributes) %>"}};var g=c.configValue,h=f.Config,i=f.Config.messages,j=f.Config.templates;return f.Field=c.Class({required:!1,requiredMessage:g(i.required),invalidTypeMessage:g(i.invalidType),labelTemplate:function(){return g(j.fieldLabel)},labelTemplateContext:function(a){return{name:this.name,value:this.label}},formControlTemplate:function(){return""},formControlTemplateContext:function(a){return{name:this.name,value:a.get(this.name)}},editorTemplate:function(){return g(j.fieldEditor)},editorTemplateContext:function(a){return{name:this.name,model:a,field:this,value:a.get(this.name)}},initialize:function(b){b||(b={}),a.extend(this,b),this.validators=this.defaultValidators(),a.extend(this.validators,b.validators)},defaultValidators:function(){return{}},validate:function(b){var d=[];return this.validateType(b)||d.push(c.printf(this.invalidTypeMessage,this)),this.required&&!this.validateRequired(b)&&d.push(c.printf(this.requiredMessage,this)),a.each(this.validators,function(a,c){var e=a.validate(b);null!=e&&(d=d.concat(e))}),d.length>0?d:!1},validateType:function(a){return!0},validateRequired:function(a){return null==a?!1:!0}}),f.StringField=f.Field.extend({invalidTypeMessage:g(i.stringFieldInvalidType),tooLongNoMinLengthMessage:g(i.stringFieldTooLongNoMinLength),tooShortNoMaxLengthMessage:g(i.stringFieldTooShortNoMaxLength),outOfRangeMessage:g(i.stringFieldOutOfRange),minLength:-1,maxLength:-1,defaultValidators:function(){var a=this;return{length:new e.StringValidator({minLength:a.minLength,maxLength:a.maxLength,messages:{tooLongNoMinLength:c.printf(a.tooLongNoMinLengthMessage,a),tooShortNoMaxLength:c.printf(a.tooShortNoMaxLengthMessage,a),outOfRange:c.printf(a.outOfRangeMessage,a)}})}},formControlTemplate:function(){return g(j.stringFieldFormControl)},validateType:function(a){return typeof a=="string"},validateRequired:function(a){return a.length>0}}),f.EmailField=f.StringField.extend({invalidEmailMessage:g(i.emailFieldInvalidEmailMessage),defaultValidators:function(){var a=this;return{email:new e.EmailValidator({messages:{invalid:a.invalidEmailMessage}})}}}),d.fields=f,f}),define("piewpiew.controllers",["piewpiew.core"],function(a){var b={};return b.Controller=a.Class({initialize:function(a){a||(a={}),a.view&&this.setView(a.view),a.model&&this.setModel(a.model)},getView:function(){return this._view},setView:function(a){return this.getView()&&this.unbindView(this.getView()),this._view=a,a&&this.bindView(a),this},bindView:function(a){},unbindView:function(a){},getModel:function(){return this._model},setModel:function(a){return this.getModel()&&this.unbindModel(this.getModel()),this._model=a,a&&this.bindModel(a),this},bindModel:function(a){},unbindModel:function(a){}}),a.controllers=b,b}),define("piewpiew.application",["underscore","backbone","piewpiew.core"],function(a,b,c){var d={};return d.Application=c.Class({el:"body",initialize:function(b){var c={},d;if(d=this.defaults)typeof d=="function"&&(d=d.call(this)),c=a.extend({},d);return this.set(c),b&&b(this),this._routerMap={},this._modelMap={},this._viewMap={},this.initializeRouter(),this.initializeModel(),this.initializeView(),this.initializeController(),this},set:function(a,b){this._options||(this._options={});if(arguments.length==2)this._options[a]=b;else for(var c in a)this._options[c]=a[c];return this},get:function(a){return this._options||(this._options={}),this._options[a]},configure:function(a,b){var c="all",d=Array.prototype.slice.call(arguments),b=d.pop();return d.length&&(c=d),(c=="all"||c.indexOf(this.env)>-1)&&b.call(this),this},initializeRouter:function(){if(this.routes){var a=this.normalizeRoutes(this.routes);this.registerRouter("default",new b.Router({routes:a}))}return this},initializeModel:function(){return this},initializeView:function(){return this},initializeController:function(){return this},registerRouter:function(a,b){this._routerMap[a]=b},normalizeRoutes:function(a){if(this.baseUrl){normalizedRoutes={};for(var b in a){var c=b.length?this.baseUrl+"/"+b:this.baseUrl;normalizedRoutes[c]=a[b]}return normalizedRoutes}return a},getRouter:function(a){return this._routerMap[a]},registerModel:function(a,b){return this._modelMap[a]=b,b.app=this,typeof b.onRegister=="function"&&b.onRegister(this),this},getModel:function(a){return this._modelMap[a]},registerView:function(a,b){return this._viewMap[a]=b,b.app=this,typeof b.onRegister=="function"&&b.onRegister(this),this},getView:function(a){return this._viewMap[a]},registerCommand:function(a,b,c){var d=this;return b.bind(c,function(){var b=new a(d);b.execute.apply(b,arguments)}),this}}),c.application=d,d}),define("piewpiew.config",["piewpiew.core"],function(a){var b={};return b.Config=a.Class({initialize:function(b){b||(b={}),b.environment||(b.environment=a.DEVELOPMENT),this.getOptions=function(){return b}},setEnvironment:function(a){return this.getOptions().environment=a,this},getEnvironment:function(){return this.getOptions().environment},get:function(b,c){var d=null,e=this.getOptions(),f=this.getEnvironment();e[f]&&(d=e[f][b]);while(null===d&&f!=a.PRODUCTION){switch(f){case a.DEVELOPMENT:f=a.TESTING;break;case a.TESTING:f=a.PRODUCTION}null!=e[f]&&(d=e[f][b])}return null!==d?this.resolveValue(d):this.resolveValue(c)},resolveValue:function(a){return typeof a=="function"?a():a}}),a.config=b,b});