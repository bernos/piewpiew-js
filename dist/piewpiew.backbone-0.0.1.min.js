/* piewpiew.backbone-0.0.1.min.js */
(function(a,b){typeof define=="function"&&define.amd?define(["underscore"],function(c){return b(a,c)}):a.piewpiew=b(a,_)})(this,function(a,b){var c={};c.printf=function(a,b){for(var c in b){var d=new RegExp("\\$\\{"+c+"\\}","g");a=a.replace(d,b[c])}return a},c.configValue=function(a){return typeof a=="function"?a():a};var d=!1;return c.Class=function(){var a=null,e=null,f=function(){d||this.initialize.apply(this,arguments)};return typeof arguments[0]=="function"?(e=arguments[0],a=arguments[1]):a=arguments[0],e&&(d=!0,f.prototype=new e,d=!1),b.extend(f.prototype,a),f.prototype.constructor=f,f.prototype.initialize||(f.prototype.initialize=function(){}),f.extend=function(a){return c.Class(this,a)},f},c}),function(a,b){typeof define=="function"&&define.amd?define(["underscore","backbone","piewpiew"],function(c,d,e){return b(a,c,d,e)}):a.piewpiew.backbone=b(a,_,Backbone,piewpiew)}(this,function(a,b,c,d){return d.Application=d.Class({el:"body",initialize:function(a){a||(a={});var c;if(c=this.defaults)typeof c=="function"&&(c=c.call(this)),a=b.extend({},c,a);return this._routerMap={},this._modelMap={},this._viewMap={},this.initializeOptions(a),this.initializeRouter(),this.initializeModel(),this.initializeView(),this.initializeController(),this},initializeOptions:function(a){b.extend(this,a)},initializeRouter:function(){if(this.routes){var a=this.normalizeRoutes(this.routes);this.registerRouter("default",new c.Router({routes:a}))}return this},initializeModel:function(){return this},initializeView:function(){return this},initializeController:function(){return this},registerRouter:function(a,b){this._routerMap[a]=b},normalizeRoutes:function(a){if(this.baseUrl){normalizedRoutes={};for(var b in a){var c=b.length?this.baseUrl+"/"+b:this.baseUrl;normalizedRoutes[c]=a[b]}return normalizedRoutes}return a},getRouter:function(a){return this._routerMap[a]},registerModel:function(a,b){return this._modelMap[a]=b,b.app=this,typeof b.onRegister=="function"&&b.onRegister(this),this},getModel:function(a){return this._modelMap[a]},registerView:function(a,b){return this._viewMap[a]=b,b.app=this,typeof b.onRegister=="function"&&b.onRegister(this),this},getView:function(a){return this._viewMap[a]},registerCommand:function(a,b,c){var d=this;return b.bind(c,function(){var b=new a(d);b.execute.apply(b,arguments)}),this}}),d.SimpleCommand=d.Class({initialize:function(a){this.app=a},execute:function(){return this}}),d.MacroCommand=d.Class({initialize:function(a){this.app=a,this.subCommands=[],this.initializeMacroCommand()},initializeMacroCommand:function(){return this},addSubCommand:function(a){return this.subCommands.push(a),this},execute:function(){while(this.subCommands.length>0){var a=this.subCommands.shift(),b=new a(this.app);b.execute.apply(b,arguments)}return this}}),d}),function(a,b){typeof define=="function"&&define.amd?define(["underscore","backbone","piewpiew"],function(c,d,e){return b(a,c,d,e)}):a.piewpiew.backbone=b(a,_,Backbone,piewpiew)}(this,function(a,b,c,d){d.models||(d.models={}),d.models.Config={messages:{},templates:{modelEditor:function(){var a=[];return a.push("<% _.each(model.fields, function(field, name) { %>"),a.push("<div>"),a.push("<%= Html.editorForField(model, field) %>"),a.push("</div>"),a.push("<% }); %>"),a.join("\n")}}};var e=d.configValue,f=d.models.Config,g=d.models.Config.messages,h=d.models.Config.templates;return d.models.Model=c.Model.extend({toJSON:function(){return b.extend(c.Model.prototype.toJSON.apply(this),{id:this.id,cid:this.cid})},editorTemplate:function(){return e(h.modelEditor)},editorTemplateContext:function(){return{model:this}},initialize:function(a,c){b.each(this.fields,function(b,c){a||(a={}),b.label||(b.label=c),b.name=c})},validate:function(a){var c={},d=!0,e=this;b.each(a,function(a,b){if(e.fields[b]){var f=e.fields[b].validate(a);f&&(d=!1,c[b]=f)}});if(!d)return c}}),d}),function(a,b){typeof define=="function"&&define.amd?define(["underscore","backbone","piewpiew"],function(c,d,e){return b(a,c,d,e)}):a.piewpiew.backbone=b(a,_,Backbone,piewpiew)}(this,function(a,b,c,d){d.models||(d.models={}),d.models.validators||(d.models.validators={}),d.models.validators.Config={messages:{stringTooLongNoMinLength:"String must have no more than ${maxLength} characters",stringTooShortNoMaxLength:"String must have at least ${minLength} characters",stringOutOfRange:"String must have between ${minLength} and ${maxLength} characters",rangeOutOfRange:"A value between ${min} and ${max} is required.",regexNoMatch:"The supplied string does not match the regular expression.",emailInvalid:"${value} is not a valid email address."}};var e=d.configValue,f=d.models.validators.Config,g=d.models.validators.Config.messages;return d.models.validators.Validator=d.Class({initialize:function(a){a||(a={}),a.messages||(a.messages={}),b.extend(this,a),this.messages=this.defaultMessages(),b.extend(this.messages,a.messages)},defaultMessages:function(){return{}},validate:function(a){return[]}}),d.models.validators.StringValidator=d.models.validators.Validator.extend({minLength:-1,maxLength:-1,defaultMessages:function(){return{tooLongNoMinLength:e(g.stringTooLongNoMinLength),tooShortNoMaxLength:e(g.stringTooShortNoMaxLength),outOfRange:e(g.stringTooShortNoMaxLength)}},validate:function(a){var b=[];return this.maxLength>-1&&a.length>this.maxLength&&b.push(this.minLength>-1?d.printf(this.messages.outOfRange,this):d.printf(this.messages.tooLongNoMinLength,this)),this.minLength>-1&&a.length<this.minLength&&b.push(this.maxLength>-1?d.printf(this.messages.outOfRange,this):d.printf(this.messages.tooShortNoMaxLength,this)),b}}),d.models.validators.RangeValidator=d.models.validators.Validator.extend({min:0,max:-1,defaultMessages:function(){return{outOfRange:e(g.rangeOutOfRange)}},validate:function(a){var b=[];return this.max<this.min?b:((a<this.min||a>this.max)&&b.push(d.printf(this.messages.outOfRange,this)),b)}}),d.models.validators.RegexValidator=d.models.validators.Validator.extend({regex:/./,defaultMessages:function(){return{invalid:e(g.regexNoMatch)}},validate:function(a){var b=[];return this.regex.test(a)||b.push(d.printf(this.messages.invalid,{value:a})),b}}),d.models.validators.EmailValidator=d.models.validators.RegexValidator.extend({regex:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,defaultMessages:function(){return{invalid:e(g.emailInvalid)}}}),d}),function(a,b){typeof define=="function"&&define.amd?define(["underscore","backbone","piewpiew","piewpiew.backbone.models.validators"],function(c,d,e,f){return b(a,c,d,e,f)}):a.piewpiew.backbone=b(a,_,Backbone,piewpiew,piewpiew.models.validators)}(this,function(a,b,c,d,e){d.models||(d.models={}),d.models.fields||(d.models.fields={}),d.models.fields.Config={messages:{required:"${label} is a required field",invalidType:"The value of ${label} is invalid",stringFieldInvalidType:"${label} must be a string",stringFieldTooLongNoMinLength:"${label} must have no more than ${maxLength} characters",stringFieldTooShortNoMaxLength:"${label} must have at least ${minLength} characters",stringFieldOutOfRange:"${label} must have between ${minLength} and ${maxLength} characters",emailFieldInvalidEmailMessage:"${value} is not a valid email address."},templates:{fieldLabel:"<%= Html.label(name, value, attributes) %>",fieldEditor:'<div <%= Html.attributeString(attributes) %>><%= Html.labelForField(model, field) %><div class="controls"><%= Html.formControlForField(model, field) %></div></div>',stringFieldFormControl:"<%= Html.textfield(name, value, attributes) %>"}};var f=d.configValue,g=d.models.fields.Config,h=d.models.fields.Config.messages,i=d.models.fields.Config.templates;return d.models.fields.Field=d.Class({required:!1,requiredMessage:f(h.required),invalidTypeMessage:f(h.invalidType),labelTemplate:function(){return f(i.fieldLabel)},labelTemplateContext:function(a){return{name:this.name,value:this.label}},formControlTemplate:function(){return""},formControlTemplateContext:function(a){return{name:this.name,value:a.get(this.name)}},editorTemplate:function(){return f(i.fieldEditor)},editorTemplateContext:function(a){return{name:this.name,model:a,field:this,value:a.get(this.name)}},initialize:function(a){a||(a={}),b.extend(this,a),this.validators=this.defaultValidators(),b.extend(this.validators,a.validators)},defaultValidators:function(){return{}},validate:function(a){var c=[];return this.validateType(a)||c.push(d.printf(this.invalidTypeMessage,this)),this.required&&!this.validateRequired(a)&&c.push(d.printf(this.requiredMessage,this)),b.each(this.validators,function(b,d){var e=b.validate(a);null!=e&&(c=c.concat(e))}),c.length>0?c:!1},validateType:function(a){return!0},validateRequired:function(a){return null==a?!1:!0}}),d.models.fields.StringField=d.models.fields.Field.extend({invalidTypeMessage:f(h.stringFieldInvalidType),tooLongNoMinLengthMessage:f(h.stringFieldTooLongNoMinLength),tooShortNoMaxLengthMessage:f(h.stringFieldTooShortNoMaxLength),outOfRangeMessage:f(h.stringFieldOutOfRange),minLength:-1,maxLength:-1,defaultValidators:function(){var a=this;return{length:new d.models.validators.StringValidator({minLength:a.minLength,maxLength:a.maxLength,messages:{tooLongNoMinLength:d.printf(a.tooLongNoMinLengthMessage,a),tooShortNoMaxLength:d.printf(a.tooShortNoMaxLengthMessage,a),outOfRange:d.printf(a.outOfRangeMessage,a)}})}},formControlTemplate:function(){return f(i.stringFieldFormControl)},validateType:function(a){return typeof a=="string"},validateRequired:function(a){return a.length>0}}),d.models.fields.EmailField=d.models.fields.StringField.extend({invalidEmailMessage:f(h.emailFieldInvalidEmailMessage),defaultValidators:function(){var a=this;return{email:new d.models.validators.EmailValidator({messages:{invalid:a.invalidEmailMessage}})}}}),d}),function(a,b){typeof define=="function"&&define.amd?define(["underscore","backbone","piewpiew","jquery"],function(c,d,e,f){return b(a,c,d,e,f)}):a.piewpiew.backbone=b(a,_,Backbone,piewpiew,$)}(this,function(a,b,c,d,e){return d.views||(d.views={}),d.views.View=c.View.extend({template:"No template specified for view",templateFunction:function(a,b){return d.views.template(a,b)},templateContext:function(){return this.model?typeof this.model.toJSON=="function"?this.model.toJSON():this.model:{}},render:function(){var a=null;return typeof this.template=="function"?a=this.template():a=this.template,e(this.el).html(this.templateFunction(a,d.views.TemplateContext(this.templateContext()))),this},onRegister:function(a){return this}}),d.views.template=function(a,c){return b.template(a,c)},d.views.TemplateContext=function(a){return b.extend(a,d.views.Helpers)},d.views.Helpers={Html:{attributeString:function(a){var c=[];return b.each(a,function(a,b){b=="classes"&&(b="class",a=a.join(" ")),c.push(d.printf('${key}="${value}"',{key:b,value:a}))}),c.join(" ")},editorForModel:function(a){return d.views.template(a.editorTemplate(),d.views.TemplateContext(a.editorTemplateContext()))},editorForField:function(a,b,c){c||(c={}),c.classes||(c.classes=[]),c.classes.push("control-group"),c.classes.push("control-group-for-"+b.name);var e=d.views.TemplateContext(b.editorTemplateContext(a));return e.attributes=c,d.views.template(b.editorTemplate(),e)},formControlForField:function(a,b,c){c||(c={}),c.classes||(c.classes=[]),c.classes.push("control"),c.classes.push("control-for-"+b.name);var e=d.views.TemplateContext(b.formControlTemplateContext(a));return e.attributes=c,d.views.template(b.formControlTemplate(),e)},labelForField:function(a,b,c){c||(c={}),c.classes||(c.classes=[]),c.classes.push("control-label");var e=d.views.TemplateContext(b.labelTemplateContext(a));return e.attributes=c,d.views.template(b.labelTemplate(),e)},hidden:function(a,b){return d.printf('<hidden name="${name}" value="${value}"/>',{name:a,value:b})},label:function(a,b,c){return d.printf('<label for="${name}" ${attributes}>${value}</label>',{name:a,value:b,attributes:this.attributeString(c)});var e},textfield:function(a,b,c){return d.printf('<input name="${name}" type="text" value="${value}" ${attributes}/>',{name:a,value:b!=null?b:"",attributes:this.attributeString(c)});var e}}},ListView=d.views.View.extend({tagName:"ul",itemTemplate:function(a){return""},itemTemplateContext:function(a){return d.view.TemplateContext(a.toJSON())},initialize:function(){this.collection.bind("reset",this.render,this),this.collection.bind("add",this.handleAdd,this),this.collection.bind("remove",this.handleRemove,this)},handleAdd:function(a,b,c){this.appendItem(a.toJSON())},handleRemove:function(){console.log("remove",arguments)},render:function(){var a=this;return e(this.el).empty(),b(this.collection.models).each(function(b){a.appendItem(b)}),this},appendItem:function(a){console.log(a),this.$el?this.$el.append("<li>"+a.name+"</li>"):this.render()}}),FormView=d.views.View.extend({template:function(){var a=[];return a.push('<form class="form-horizontal">'),this.model.id&&a.push('<%= Html.hidden("id", model.id) %>'),a.push('<%= Html.hidden("cid", model.cid) %>'),a.push("<%= Html.editorForModel(model) %>"),a.push('<input type="submit" value="save"/>'),a.push("</form>"),a.join("\n")},initialize:function(a){this.model&&this.model.bind("error",this.handleError,this)},templateContext:function(){return{model:this.model}},events:{"submit form":"handleSubmit","blur input":"handleBlur","focus input":"handleFocus"},handleSubmit:function(a){var b=this.$("form").serializeObject();this.clearErrors(),null!=this.model&&this.model.set(b)&&this.trigger("submit",this),a.preventDefault()},handleFocus:function(a){},handleBlur:function(a){var b=e(a.target);this.clearErrorFor(b.attr("name")),this.model.set(b.attr("name"),b.val())},handleError:function(a,c){var d=this;b.each(c,function(a,b){var c=d.formatErrorMessagesFor(b,a),e=d.formatErrorElementFor(b,c);d.clearErrorFor(b),d.attachErrorElementFor(b,e)})},clearErrors:function(){this.$(".control-group.error .help-inline").remove(),this.$(".control-group.error").removeClass("error")},clearErrorFor:function(a){this.$(".control-group-for-"+a+".error .help-inline").remove(),this.$(".control-group-for-"+a+".error").removeClass("error")},formatErrorMessagesFor:function(a,b){return b.join(" ")},formatErrorElementFor:function(a,b){return'<span class="help-inline generated">'+b+"</span>"},attachErrorElementFor:function(a,b){var c=this.$("*[name="+a+"]");c.parent().append(b),c.closest(".control-group").addClass("error")}}),e.fn.serializeObject=function(){var a={},b=this.serializeArray();return e.each(b,function(){a[this.name]!==undefined?(a[this.name].push||(a[this.name]=[a[this.name]]),a[this.name].push(this.value||"")):a[this.name]=this.value||""}),a},d})